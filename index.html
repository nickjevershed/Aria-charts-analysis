<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  margin:0px;
}

.chart { 
  background: #fff;
  width:940px;
}

.remove p {
  font: 20px helvetica;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
  shape-rendering: crispEdges;
}

button {
  position: absolute;
  right: 50px;
  top: 10px;
}

.chart {

  position: relative;
}

.filterText {

    font-size: 20px;
    font-weight: bold;
}

.reset {

  font-weight: bold;
  font-size: 12px;
  cursor: pointer;
}

.infobox {

  font-size: 12px;
}

.genre {

  font-size: 16px;
}


.ui-tooltip-content {

  z-index: 60;
}

#tableWrapper {

      width:940px;
}

#nextItem {
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
}

#guidedTour {

  font-size: 20px;
}      

</style>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/d3.min.js"></script>
<link rel="stylesheet" href="css/jquery-ui-1.10.3.custom.min.css" />
<script src="js/jquery-ui-1.10.3.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="css/jquery.dataTables.css" />
<body>
<div id="tour">
  <span id="guidedTour">Click next to see some of the key trends</span> <span id="nextItem">next >></span>
</div>  
<div id="chartContainer">
<div class="chart">
</div>
</div>

<div id="tableWrapper">
<table id="list" width="100%">
  <thead>
    <tr>
      <th class="Year-cell">Year</th>
      <th class="Rank-cell">Rank</th>
      <th class="Artist-cell">Artist</th>
      <th class="Song-cell">Song</th>
      <th class="Genre1-cell">Genre1</th>
      <th class="Genre2-cell">Genre2</th>
    </tr>
  </thead>
  <tbody>
   
  </tbody>
 
</table>
</div>
<script>

var genreNeat = "";

 $.fn.dataTableExt.afnFiltering.push(
      function( oSettings, aData, iDataIndex ) {
        
        var genre1 = aData[4];
        var genre2 = aData[5];
        if (genreNeat == "") {
          return true;
        }

        else if ( genre1 == genreNeat)
        {
          return true;
        }
        else if ( genre2 == genreNeat)
        {
          return true;
        }
        return false;
      }
      );


$(document).ready(function() {



var oTable = $('#list').dataTable( {
    "oLanguage": {
        "sSearch": "Filter all columns:"
    },
    "bProcessing": true,
    "sAjaxSource": 'hottest100.json',
    "bScrollInfinite": true,
    "bScrollCollapse": false,
    "sScrollY": "600px",
    "iDisplayLength": 100,
    "aaSorting": [[0,"desc"]]

} );

oTable.fnDraw();

var tourItem = 0;

var datearray = [];
var colorrange = [];

strokecolor = "black";

var orange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"];
var blue = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
var pink = ["#980043", "#DD1C77", "#DF65B0", "#C994C7", "#D4B9DA", "#F1EEF6"];

var margin = {top: 50, right: 30, bottom: 30, left: 30};
var width = 940 - margin.left - margin.right;
var height = 650 - margin.top - margin.bottom;

var catA = ["80s","90s","acoustic","adult contemporary","afrobeat","afropop","alternative","alternative metal","americana","anti-folk","ballad","big band","black metal","bluegrass","blues","british pop","college rock","comedy","country","cowpunk","dream pop","emo","folk","folk rock","folk-pop","french pop","funk","garage rock","gothic rock","grindcore","grunge","hard rock","hardcore","heavy metal","indie","indie pop","indie rock","industrial metal","industrial rock","instrumental","jazz","lo-fi","lounge","math rock","metal","metalcore","new wave","nu metal","pop","pop punk","pop rock","post-hardcore","post-punk","power pop","progressive metal","progressive rock","psychedelic","psychedelic rock","punk","rap rock","reggae","rock","rock 'n roll","rockabilly","roots","singer-songwriter","ska","soundtrack","southern rock","world"]

var catB = ["acid house","ambient","big beat","breakbeat","breakcore","cyberpunk","dance","dance pop","deep house","disco","disco house","downtempo","drum and bass","dubstep","edm","electro","electro house","electroclash","electronic","electronica","electropop","eurodance","experimental","french house","house","industrial","minimal","new rave","nu disco","synthpop","techno","trance","bounce","club","dancehall","dub","grime","hip hop","r&b","rap","remix","scratch","soul","spoken word","trip hop"]


var reset = d3.select(".chart")
    .append("div")
    .attr("class", "reset")
    .style("position", "absolute")
    .style("z-index", "30")
    .style("visibility", "hidden")
    .style("top", "70px")
    .style("right", "55px");

var filterText = d3.select(".chart")
    .append("div")
    .attr("class", "filterText")
    .style("position", "absolute")
    .style("z-index", "20")
    .style("visibility", "hidden")
    .style("top", "30px")
    .style("right", "55px");
        
reset.html( "<p title='test'>RESET CHART</p>" );

var info;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height-20, 0]);

var z = d3.scale.ordinal()
    .range(colorrange);

var orRange = d3.scale.ordinal()
    .range(orange);

var pkRange = d3.scale.ordinal()
    .range(pink);

var blRange = d3.scale.ordinal()
    .range(blue);             

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickFormat(d3.format("d"));

var yAxis = d3.svg.axis()
    .scale(y)

var yAxisr = d3.svg.axis()
    .scale(y);

var stack = d3.layout.stack()
    .offset("silhouette")
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    .y(function(d) { return d.value; });

 var stackArea = d3.layout.stack()
    .offset("zero")
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    .y(function(d) { return d.value; });    

var nest = d3.nest()
    .key(function(d) { return d.key; });

var area = d3.svg.area()
    .interpolate("cardinal")
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var svg = d3.select(".chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")"); 

var graph = d3.csv("genre-count.csv", function(data) {
  data.forEach(function(d) {
    d.date = +d.date;
    d.value = ((+d.value)/200)*100;
  });

  var layers = stack(nest.entries(data));
  x.domain(d3.extent(data, function(d) { return d.date; }));
  y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);


  svg.selectAll(".layer")
      .data(layers, function(d){ return d.key.replace(/[\s\.]/g,'_') } )
    .enter().append("path")
      .attr("class", "layer")
      .attr("title", function(d) {return d.key})
      .attr("id", function(d){ return d.key.replace(/[\s\.]/g,'_') } )
      .attr("d", function(d) { 
        return area(d.values); })
      .style("fill", function(d, i) { 
        if (catA.indexOf(d.key) > -1) {

          return orRange(i); 

        }

        else if (catB.indexOf(d.key) > -1) {

          return blRange(i);

        }

      });
  
  $( ".layer" ).tooltip({content:"<div class='infobox'></div>", track:true});

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + width + ", 0)")
      .call(yAxis.orient("right"));

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis.orient("left"));

  reset
    .on("click", function(d, i) {

            var selected = svg.selectAll(".layer").data(stack(layers), function(d){ return d.key.replace(/[\s\.]/g,'_') } );

            selected
              .transition()
              .attr("d", function(d) { 
              return area(d.values); });

            reset.style("visibility", "hidden");
            filterText.style("visibility", "hidden");
            genreNeat = "";
            oTable.fnDraw();
    });    

  

  svg.selectAll(".layer")
    .attr("opacity", 1)
    .on("click", function(d, i) {

      genreID = d3.select(this).attr("id");
      genreData = stackArea(layers.filter(function(d) { return d.key == genreID.replace('_',' ') }));

      var selected = svg.selectAll(".layer").data(genreData, function(d){ return d.key.replace(/[\s\.]/g,'_') } )

      selected.exit()
        .transition()
          .attr("d","M0,0")


      selected
        .transition()
        .attr("d", function(d) { 
        return area(d.values); })   

      genreNeat = genreID.replace('_',' ');  
      reset.style("visibility", "visible");
      filterText.style("visibility", "visible");  
      filterText.html( "<p>Showing: " + genreID.replace('_',' ') + "</p>" );
      oTable.fnDraw();



    })
    .on("mouseover", function(d, i) {
      svg.selectAll(".layer").transition()
      .duration(250)
      .attr("opacity", function(d, j) {
        return j != i ? 0.6 : 1;
    })

    })

    .on("mousemove", function(d, i) {
      mousex = d3.mouse(this);
      mousex = mousex[0];
      var invertedx = x.invert(mousex);

      var selected = (d.values);
      for (var k = 0; k < selected.length; k++) {
        datearray[k] = selected[k].date
      }

      mousedate = datearray.indexOf(invertedx | 0);
      pro = d3.round(d.values[mousedate].value,1);

      d3.select(this)
      .classed("hover", true)
      .attr("stroke", strokecolor)
      .attr("stroke-width", "0.5px"); 
      $(".infobox").html( "<span class='genre'>Genre: " + d.key + "</span><br>Proportion: " + pro + "%<br>Year: " + (invertedx | 0) + "<br>Click to filter" );

     

    })
    .on("mouseout", function(d, i) {
     svg.selectAll(".layer")
      .transition()
      .duration(250)
      .attr("opacity", "1");
      d3.select(this)
      .classed("hover", false)
      .attr("stroke-width", "0px");
  })

  $("#nextItem").on("click", function() {
    guidedTour();
  });
  
  function guidedTour() {

    if (tourItem == 0) {

        $("#guidedTour").html("The decline of rock");
        genreData = stackArea(layers.filter(function(d) { return d.key == "rock" | d.key == "alternative" }));

        var selected = svg.selectAll(".layer").data(genreData, function(d){ return d.key.replace(/[\s\.]/g,'_') } )

      selected.exit()
        .transition()
          .attr("d","M0,0")


      selected
        .transition()
        .attr("d", function(d) { 
        return area(d.values); })   
 
      reset.style("visibility", "visible");
      filterText.style("visibility", "visible");  
      //filterText.html( "<p>Showing: " + genreID.replace('_',' ') + "</p>" );
      //oTable.fnDraw();


    }

    else if (tourItem == 1) {

      $("#guidedTour").html("The rise of electronic music");

      genreData = stackArea(layers.filter(function(d) { return d.key == "acid house" |d.key == "ambient" |d.key == "big beat" |d.key == "breakbeat" |d.key == "breakcore" |d.key == "cyberpunk" |d.key == "dance" |d.key == "dance pop" |d.key == "deep house" |d.key == "disco" |d.key == "disco house" |d.key == "downtempo" |d.key == "drum and bass" |d.key == "dubstep" |d.key == "edm" |d.key == "electro" |d.key == "electro house" |d.key == "electroclash" |d.key == "electronic" |d.key == "electronica" |d.key == "electropop" |d.key == "eurodance" |d.key == "experimental" |d.key == "french house" |d.key == "house" |d.key == "industrial" |d.key == "minimal" |d.key == "new rave" |d.key == "nu disco" |d.key == "synthpop" |d.key == "techno" |d.key == "trance" |d.key == "bounce" |d.key == "club" |d.key == "dancehall" |d.key == "dub" |d.key == "grime" |d.key == "hip hop" |d.key == "r&b" |d.key == "rap" |d.key == "remix" |d.key == "scratch" |d.key == "soul" |d.key == "spoken word" |d.key == "trip hop"}));

      var selected = svg.selectAll(".layer").data(genreData, function(d){ return d.key.replace(/[\s\.]/g,'_') } )

      selected.exit()
        .transition()
          .attr("d","M0,0")


      selected
        .transition()
        .attr("d", function(d) { 
        return area(d.values); })   
 
      reset.style("visibility", "visible");
      filterText.style("visibility", "visible");  
      //filterText.html( "<p>Showing: " + genreID.replace('_',' ') + "</p>" );
      //oTable.fnDraw();

    }

    if (tourItem <= 5) {
      tourItem++;
    }

    else {

      tourItem = 0;
    }

  };  

  
});

});


</script>