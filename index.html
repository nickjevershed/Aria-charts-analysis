<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="css/jquery-ui-1.10.3.custom.min.css" />
  <link rel="stylesheet" href="css/jquery.dataTables.css" /> 
  <link rel="stylesheet" href="css/fonts.css" /> 
  <link rel="stylesheet" type="text/css" href="css/arias.css" /> 
  <style>

  </style>




</head>

<body>
<div id="interactiveWrapper">
<img src="img/hilltop.jpg" width="100%"/>
<div class="caption">MC Pressure from the Australian duo Hilltop Hoods during their performance at the Splendour in the Grass music festival. Hip hop and electronic music are becoming more popular. Photograph: Dan Peled</div>

<div class="interactiveText"><p><span class="dropcap">A</span>n analysis of the top singles charts for Australia since 1988 suggests rock and conventional band music generally are declining in popularity and that pop songs are getting shorter. </p>

<p>I have analysed the <a href='http://www.aria.com.au/pages/aria-charts-end-of-year-charts.htm' target='_blank'>Aria singles charts from 1988 to 2014</a> to get a sense of how our popular music is changing.</p>

<p>The annual Aria charts are produced by the Australian Recording Industry Association, and track sales of singles from <a href='http://www.ariacharts.com.au/about/chart-stores' target='_blank'>a number of sources</a>, including bricks-and-mortar stores and online and streaming outlets such as iTunes and Spotify.   </p>

<p>To examine music genres over time, I used <a href='http://developer.echonest.com/docs/v4'>the Echo Nest music classification service</a> to programmatically assign genres to each artist in the top 100, or top 50 for charts between 1988 and 1996. I took the first two genres associated with each artist, cleaned up the data to condense certain obscure genres into more familiar ones (eg. deep house and other house music sub-genres condensed to house), and then calculated the percentage of each genre in each year.</p>

<p>This chart shows the proportion of each genre, with each genre loosely grouped into arbitrary categories of conventional band (i.e. music with guitars and regular instruments), pop music (anything falling under pop's various umbrellas regardless of instrumentation), electronic (most of the dance genres) and urban (primarily hip-hop, R&B, rap and soul).</p>
</div>

<div id="streamGraphWrapper">
  <div class="topbar"></div>
  <div class="chartTitle">Chart music genres over time</div>
  <div class="row">
    <span id="toggleText">Click to zoom on group of genres, click a stream to isolate a genre, or select from this list: 
    <select id="genreMenu">
    <option value='adult_contemporary'>adult contemporary</option>
<option value='alternative_metal'>alternative metal</option>
<option value='alternative_rock'>alternative rock</option>
<option value='ambient'>ambient</option>
<option value='ballad'>ballad</option>
<option value='bluegrass'>bluegrass</option>
<option value='blues'>blues</option>
<option value='boy_band'>boy band</option>
<option value='breakbeat'>breakbeat</option>
<option value='british_pop'>british pop</option>
<option value='celtic'>celtic</option>
<option value='children_music'>children music</option>
<option value='christian'>christian</option>
<option value='classic_rock'>classic rock</option>
<option value='classical'>classical</option>
<option value='club'>club</option>
<option value='comedy'>comedy</option>
<option value='country'>country</option>
<option value='crunk'>crunk</option>
<option value='dance'>dance</option>
<option value='dance_pop'>dance pop</option>
<option value='dancehall'>dancehall</option>
<option value='disco'>disco</option>
<option value='disney_music'>disney music</option>
<option value='doo-wop'>doo-wop</option>
<option value='downtempo'>downtempo</option>
<option value='drum_and_bass'>drum and bass</option>
<option value='dubstep'>dubstep</option>
<option value='easy_listening'>easy listening</option>
<option value='electro'>electro</option>
<option value='electronic'>electronic</option>
<option value='electropop'>electropop</option>
<option value='emo'>emo</option>
<option value='eurodance'>eurodance</option>
<option value='europop'>europop</option>
<option value='folk'>folk</option>
<option value='funk'>funk</option>
<option value='funk_rock'>funk rock</option>
<option value='garage_rock'>garage rock</option>
<option value='glam_rock'>glam rock</option>
<option value='gospel'>gospel</option>
<option value='grime'>grime</option>
<option value='grunge'>grunge</option>
<option value='hard_rock'>hard rock</option>
<option value='hardcore'>hardcore</option>
<option value='hardcore_punk'>hardcore punk</option>
<option value='heavy_metal'>heavy metal</option>
<option value='hip_hop'>hip hop</option>
<option value='house'>house</option>
<option value='indie_rock'>indie rock</option>
<option value='jazz'>jazz</option>
<option value='jazz_fusion'>jazz fusion</option>
<option value='k_pop'>k pop</option>
<option value='latin'>latin</option>
<option value='male_vocalist'>male vocalist</option>
<option value='melodic_rock'>melodic rock</option>
<option value='metal'>metal</option>
<option value='motown'>motown</option>
<option value='new_age'>new age</option>
<option value='new_jack_swing'>new jack swing</option>
<option value='new_wave'>new wave</option>
<option value='nu_metal'>nu metal</option>
<option value='old_school'>old school</option>
<option value='opera'>opera</option>
<option value='parody'>parody</option>
<option value='pop'>pop</option>
<option value='pop_punk'>pop punk</option>
<option value='pop_rock'>pop rock</option>
<option value='post-punk'>post-punk</option>
<option value='power_pop'>power pop</option>
<option value='pub_rock'>pub rock</option>
<option value='punk'>punk</option>
<option value='r&b'>r&b</option>
<option value='rap'>rap</option>
<option value='rap_metal'>rap metal</option>
<option value='rap_rock'>rap rock</option>
<option value='reggae'>reggae</option>
<option value='reggaeton'>reggaeton</option>
<option value='rock'>rock</option>
<option value='rockabilly'>rockabilly</option>
<option value='singer-songwriter'>singer-songwriter</option>
<option value='ska'>ska</option>
<option value='soft_rock'>soft rock</option>
<option value='soul'>soul</option>
<option value='soundtrack'>soundtrack</option>
<option value='surf_music'>surf music</option>
<option value='swing'>swing</option>
<option value='symphony'>symphony</option>
<option value='synthpop'>synthpop</option>
<option value='techno'>techno</option>
<option value='teen_pop'>teen pop</option>
<option value='trance'>trance</option>
<option value='trip_hop'>trip hop</option>
<option value='uk_garage'>uk garage</option>
<option value='world'>world</option>
</select>
 </span>
  </div>

  <span id="streamGraphfilters" class="filter">
    <span data-category="band" class="btn traditionalBand">Conventional band</span>
    <span data-category="electronic" class="btn electronic">Electronic</span>
    <span data-category="urban" class="btn urban">Urban</span>
    <span data-category="pop" class="btn popMusic">Pop music</span>
    <span data-category="other" class="btn other">Other</span>
  </span>
  <span class="btn reset">Reset</span>

  <div id="streamGraph" class="chart">
  </div>
</div>

<div class="interactiveText">
<p>The most obvious trend is that, like our <a href='http://www.theguardian.com/news/datablog/interactive/2014/jan/23/hottest-100-every-genre-interactive' target='_blank'>previous look at music genres in Triple J's hottest 100</a>, the proportion of rock and other guitar-based music genres is declining. This is largely being driven by a corresponding increase in popularity of the urban and electronic genres. </p>

<p>Dance music genres such as house and trance (as well as the generic “dance” genre) are enjoying a resurgence in recent years after peaks in the 90s and early 2000s. </p>

<p>You can choose individual genre streams in the chart above to explore other trends. </p>

<p>Looking at the length of tracks in the charts, it looks like songs are getting shorter on average. </p>

<p>Unfortunately, it would be hard to definitively say the songs in the charts are getting shorter without scoring each track for duration by hand (which would take days). </p>

<p>To get the duration, I used the same Echo Nest API to assign a length to each song. Doing this programmatically based on the song title and artist has a few issues: some songs have multiple versions, so it is tricky to always get the length of version that made it into the charts though the most popular version of the track should be the preferred version returned. Also some songs do not have a duration recorded, or the length is obviously incorrect. To reduce the errors from using a single service, I also extracted durations from the YouTube version of each song, as well as the duration of the first matching track on Last FM. </p>

<p>All three datasets showed a trend from longer tracks to shorter over time. So, while individual songs may not have the right length, I'm pretty sure the overall trend is solid. Here's a view of song durations based on a combined dataset of the three, with a line showing the trend:</p>

</div>


<div id="durationGraphWrapper">

  <div class="topbar"></div>
  <div class="chartTitle">Chart music duration over time</div>
  <div class="row keyText">
   <p>Click to toggle groups of genres. Duration determined programatically by API and may not reflect actual radio single duration</p>
  </div>
  <span id="durationScatterfilters" class="filter">
    <span data-category="band" class="btn traditionalBand">Conventional band</span>
    <span data-category="electronic" class="btn electronic">Electronic</span>
    <span data-category="urban" class="btn urban">Urban</span>
    <span data-category="pop" class="btn popMusic">Pop music</span>
    <span data-category="other" class="btn other">Other</span>   
  </span>
  <div id="durationScatter" class="chart">
  </div>
</div>

<div class="interactiveText">
<p>The obvious outliers in length are the split singles such as Elton John's Candle in the Wind / Something About the Way You Look Tonight, and All Saints covers of Under the Bridge / Lady Marmalade. </p>

<p>On the shorter side of things, Liam Lynch's United States of Whatever from 2003 was the shortest track to chart, at 89 seconds. The second-shortest track in the charts was also in the same year, Hey Hey What You Say, from the Saddle Club. </p>

<p>Each entry in the Aria charts has the associated record label or company responsible for releasing the song in Australia. I scored each company as a major label, independent label, or public broadcaster based on information from music databases discogs.com and musicbrainz.org. Again, these proportions should be taken as estimates because the definition of “major” or “independent” is an arbitrary one. </p>

<p>Some labels and companies were scored as unknown where I wasn't able to find any information about the label from the abbreviation on the Aria chart. However, it is likely these are mostly independent because the majors would be readily identifiable. </p>
</div>

<div id="labelGraphWrapper">
  <div class="topbar"></div>
  <div class="chartTitle">Proportion of major labels v independent over time</div>
  <div class="row keyText">
    <span class="keySquare blue1"></span><span>Major label</span>
    <span class="keySquare blue2"></span><span>Independent label</span>
    <span class="keySquare blue3"></span><span>Unknown (probably independent)</span>
    <span class="keySquare blue4"></span><span>Public broadcaster</span>
  </div>  
  <div id="labelColumn" class="chart">

  </div>
</div>  

<div class="interactiveText">
<p>  The dominance of the major labels and record companies in popular music is still quite large, though independent labels have been making inroads into the charts since the mid-90s. </p>

<p>The high point for releases outside the major companies was 2002, with a number of electronic music releases on Shock Records and Ministry of Sound, as well as a strong year for Jay Z's initially independent label Roc-A-Fella Records. </p>

<p>Finally, a look at the proportion of Australian artists in the charts. Again, I used the Echo Nest API to classify the country of origin of each artist, and converted the results into percentages. The three largest countries of origin were the US, UK and Australia, with another 20 or so other countries (I've merged these into “other” for the purposes of the graph, but you can check out the full results in the spreadsheet).</p>

</div>

<div id="countryGraphWrapper">
  <div class="topbar"></div>
  <div class="chartTitle">Country of origin of artists in charts</div>

  <div class="row keyText">
    <span class="keySquare blue1"></span><span>United States</span>
    <span class="keySquare blue2"></span><span>Australia</span>
    <span class="keySquare blue3"></span><span>United Kingdom</span>
    <span class="keySquare blue4"></span><span>Other</span>
  </div>  


  <div id="countryColumn" class="chart">

  </div>  

  <div class="interactiveText">
   <p> Australian artists make up a decent portion of the charts each year, though it is usually far less than American artists. Interestingly, 2014 has the lowest proportion of American artists, and it looks like this proportion has been declining since 2009. Last year was also a particularly strong year for the Brits, and other countries generally. </p>

<p>Finally, a big caveat: as mentioned, the ability to produce these sorts of analyses in a reasonable period of time relies on classifying tracks programmatically, with all the associated issues. I've no doubt there are entries in the data that have been mis-classified, or use the wrong duration or artist due to a mismatch. If you spot an error, you can fork the dataset on GitHub to fix it, or for those less technically inclined, you can <a href='https://docs.google.com/spreadsheets/d/1iUY17-FbO5Ca8zWOIEbomUq-Zmb1QlVQqF_H1WZ8I-U/edit?usp=sharing' target='_blank'>duplicate the Google Doc spreadsheet here</a>.</p>
  </div>  


</div>

</div>

<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="js/d3.min.js"></script>
<script src="js/jquery-ui-1.10.3.custom.min.js"></script>
<script src="http://interactive.guim.co.uk/libs/iframe-messenger/iframeMessenger.js" type="text/javascript"></script>

<script>

iframeMessenger.enableAutoResize();

var genreNeat = "";

var clickTo = "Click to filter";


$(document).ready(function() {


var getW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
var getH = getW*0.5;
var sizeRatio = getW/1300;

//Smaller graph for smaller screens

if (getW > 1300) {
  getW = 1300;
  getH = getW*0.5;
  sizeRatio = getW/1300;
}


function drawStreamGraph() {


var datearray = [];
var colorrange = [];

strokecolor = "black";

var grey = ['rgb(247,247,247)','rgb(217,217,217)','rgb(189,189,189)','rgb(150,150,150)','rgb(99,99,99)','rgb(37,37,37)'];
var blue = ['rgb(239,243,255)','rgb(198,219,239)','rgb(158,202,225)','rgb(107,174,214)','rgb(49,130,189)','rgb(8,81,156)'];
var red = ['rgb(254,229,217)','rgb(252,187,161)','rgb(252,146,114)','rgb(251,106,74)','rgb(239,59,44)','rgb(203,24,29)','rgb(153,0,13)'];
var green = ['rgb(237,248,233)','rgb(199,233,192)','rgb(161,217,155)','rgb(116,196,118)','rgb(49,163,84)','rgb(0,109,44)'];
var purple = ['rgb(242,240,247)','rgb(218,218,235)','rgb(188,189,220)','rgb(158,154,200)','rgb(117,107,177)','rgb(84,39,143)']


var margin = {top: 15, right: 30, bottom: 30, left: 30};
var width = getW - margin.left - margin.right;
var height = getH - margin.top - margin.bottom;

var info;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height-20, 0]);

var z = d3.scale.ordinal()
    .range(colorrange);

var greenRange = d3.scale.ordinal()
    .range(green);

var blueRange = d3.scale.ordinal()
    .range(blue);

var purpleRange = d3.scale.ordinal()
    .range(purple);             

var redRange = d3.scale.ordinal()
    .range(red);

var greyRange = d3.scale.ordinal()
    .range(grey);       


var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickFormat(d3.format("d"));

var yAxis = d3.svg.axis()
    .scale(y)

var yAxisr = d3.svg.axis()
    .scale(y);

var stack = d3.layout.stack()
    .offset("silhouette")
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    .y(function(d) { return d.value; });

 var stackArea = d3.layout.stack()
    .offset("offset")
    .values(function(d) { return d.values; })
    .x(function(d) { return d.date; })
    .y(function(d) { return d.value; });    

var nest = d3.nest()
    .key(function(d) { return d.key; });

var area = d3.svg.area()
    .interpolate("cardinal")
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var svg = d3.select("#streamGraph").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")"); 

var graph = d3.csv("data/genres-percent-groups.csv", function(data) {
  data.forEach(function(d) {
    d.date = +d.date;
    d.value = +d.value;
  });

  var layers = stack(nest.entries(data));

  x.domain(d3.extent(data, function(d) { return d.date; }));
  y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);

  svg.selectAll(".layer")
      .data(layers, function(d){ return d.key.replace(/[\s\.]/g,'_') } )
    .enter().append("path")
      .attr("class", function(d) {return "layer " + d['values'][0]['group'].replace(/[\s\.]/g,'_')})
      .attr("title", function(d) {return d.key})
      .attr("id", function(d){ return d.key.replace(/[\s\.]/g,'_') } )
      .attr("d", function(d) { 
        return area(d.values); })
      .style("fill", function(d, i) {
        if (d['values'][0]['group'] === 'band' ) {
          return greenRange(i); 
        }

        else if (d['values'][0]['group'] === 'pop' ) {

          return redRange(i);
          
        }
        else if (d['values'][0]['group'] === 'electronic' ) {

          return purpleRange(i);
          
        }

         else if (d['values'][0]['group'] === 'urban' ) {

          return blueRange(i);
          
        }

         else if (d['values'][0]['group'] === 'other' ) {

          return greyRange(i);
          
        }

      });


  //hard coded labels because streamgraph labelling layout is HARD    

  var labelPositions = [
  {"label":"pop","x":1998,"y":68,"max":35},
  {"label":"rock","x":1990,"y":25,"max":25},
  {"label":"dance","x":1999,"y":35,"max":15},
  {"label":"r&b","x":2011,"y":80,"max":17}
  ]

  svg.selectAll(".streamLabelShadow")
        .data(labelPositions)
        .enter().append("text")
        .attr("class","shadow streamLabelShadow")
        .attr("y", function(d) {return y(d.y)})
        .attr("x", function(d) {return x(d.x)})
        .style("font-size",function(d) { return d.max*sizeRatio + "px"  })
        .style("text-anchor", "center")
        .text(function(d) {return d['label']})


  svg.selectAll(".streamLabel")
        .data(labelPositions)
        .enter().append("text")
        .attr("class","streamLabel")
        .attr("y", function(d) {return y(d.y)})
        .attr("x", function(d) {return x(d.x)})
        .style("font-size",function(d) { return d.max*sizeRatio + "px" })
        .style("text-anchor", "center")
        .text(function(d) {return d['label']})


  $( ".layer" ).tooltip({content:"<div class='infobox' onClick='tooltipClose();'></div>", track:true});

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis right")
      .attr("transform", "translate(" + width + ", 0)")
      .call(yAxis.orient("right"))
      .append("text")
      .attr("class", "label")
      .attr("dy", "2em")
      .attr("dx", "1.5em")
      .style("text-anchor", "end")
      .text("%");;

  svg.append("g")
      .attr("class", "y axis left")
      .call(yAxis.orient("left"))
      .append("text")
      .attr("class", "label")
      .attr("dy", "2em")
      .attr("dx", "-0.5em")
      .style("text-anchor", "end")
      .text("%");


  d3.select(".reset")
    .on("click", function(d, i) {

      resetChart();
            
    });    

  
  function resetChart() {

     $("#streamGraphWrapper .reset").fadeOut();
    $("#streamGraphWrapper .streamLabel").fadeIn();
    $("#streamGraphWrapper .streamLabelShadow").fadeIn();

    var selected = svg.selectAll(".layer").data(stack(layers), function(d){ return d.key.replace(/[\s\.]/g,'_') } );

    y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);

    d3.select(".y.left")
        .transition()
        .call(yAxis.orient("left"));

    d3.select(".y.right")
        .transition()
        .call(yAxis.orient("right"));    

    selected
      .transition()
      .attr("d", function(d) { 
      return area(d.values); });


    genreNeat = "";

  }


  d3.selectAll("#streamGraphfilters .btn").on("click", filterCat);

  d3.select("#genreMenu").on("change", filterGenre);

  function filterGenre() {

      $("#streamGraphWrapper .reset").fadeIn().css("display","inline-block");
      $("#streamGraphWrapper .streamLabel").fadeOut();
      $("#streamGraphWrapper .streamLabelShadow").fadeOut();

      genreID = d3.select(this).node().value;
      console.log(genreID);
      genreData = stackArea(layers.filter(function(d) { return d.key == genreID.replace('_',' ') }));

      var selected = svg.selectAll(".layer").data(genreData, function(d){ return d.key.replace(/[\s\.]/g,'_') } )

      selected.exit()
        .transition()
          .attr("d","M0,0");

      selected
        .attr("d", function(d) { 
        return area(d.values); });   

      genreNeat = genreID.replace('_',' ');  
      clickTo = "";


  }

  function filterCat() {

                $("#streamGraphWrapper .reset").fadeIn().css("display","inline-block");
                $("#streamGraphWrapper .streamLabel").fadeOut();
                $("#streamGraphWrapper .streamLabelShadow").fadeOut();


                var currElement = d3.select(this)
                var catID = currElement.attr("data-category");

                filterData = data.filter(function(d) { return d['group'] == catID })

                var filterCatYear = d3.nest()
                    .key(function(d) { return d.date; })
                    .rollup(function(leaves) { return {"total": d3.sum(leaves, function(d) {return (d['value']);})} })
                    .entries(filterData);

                y.domain([0, d3.max(filterCatYear, function(d) { return d['values']['total']; })])

                 d3.select(".y.left")
                    .transition()
                    .call(yAxis.orient("left"));

                d3.select(".y.right")
                    .transition()
                    .call(yAxis.orient("right"));  
 

                genreData = stackArea(layers.filter(function(d) { return d['values'][0]['group'] == catID }));

                var selected = svg.selectAll(".layer").data(genreData, function(d){ return d.key.replace(/[\s\.]/g,'_') } )

                selected.exit()
                  .transition()
                    .attr("d","M0,0")


                selected
                  .transition()
                  .attr("d", function(d) { 
                  return area(d.values); })   

              };    


  svg.selectAll(".layer")
    .attr("opacity", 1)
    .on("click", function(d, i) {

      $("#streamGraphWrapper .reset").fadeIn().css("display","inline-block");
      $("#streamGraphWrapper .streamLabel").fadeOut();
      $("#streamGraphWrapper .streamLabelShadow").fadeOut();

      genreID = d3.select(this).attr("id");
      genreData = stackArea(layers.filter(function(d) { return d.key == genreID.replace('_',' ') }));

      var selected = svg.selectAll(".layer").data(genreData, function(d){ return d.key.replace(/[\s\.]/g,'_') } )

      selected.exit()
        .transition()
          .attr("d","M0,0");

      selected
        .attr("d", function(d) { 
        return area(d.values); });   

      genreNeat = genreID.replace('_',' ');  
      clickTo = "";


    })
    .on("mouseover", function(d, i) {
      svg.selectAll(".layer").transition()
      .duration(250)
      .attr("opacity", function(d, j) {
        return j != i ? 0.6 : 1;
    })

    })

    .on("mousemove", function(d, i) {
      mousex = d3.mouse(this);
      mousex = mousex[0];
      var invertedx = x.invert(mousex);

      var selected = (d.values);
      for (var k = 0; k < selected.length; k++) {
        datearray[k] = selected[k].date
      }

      mousedate = datearray.indexOf(invertedx | 0);
      pro = d3.round(d.values[mousedate].value,1);

      d3.select(this)
      .classed("hover", true)
      .attr("stroke", strokecolor)
      .attr("stroke-width", "0.5px"); 
      $(".infobox").html( "<span class='infoboxHeader'>Genre: " + d.key + "</span><br>Proportion: " + pro + "%<br>Year: " + (invertedx | 0) + "<br>" + clickTo );

     

    })
    .on("mouseout", function(d, i) {
     svg.selectAll(".layer")
      .transition()
      .duration(250)
      .attr("opacity", "1");
      d3.select(this)
      .classed("hover", false)
      .attr("stroke-width", "0px");
  })

    function tooltipClose() {
$(".infobox").tooltip('close');
}

});

}


function drawDurationScatter() {

var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = getW - margin.left - margin.right,
    height = getH - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickFormat(d3.format("d"));

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var svg = d3.select("#durationScatter").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("data/duration-groups-en.csv", function(error, data) {
  data.forEach(function(d) {
    d.duration = +d.duration;
  });

  console.log(data);

  x.domain(d3.extent(data, function(d) { return d.year; })).nice();
  y.domain(d3.extent(data, function(d) { return d.duration; })).nice();

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
  
  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Duration (sec)")

  svg.selectAll(".dot")
      .data(data)
    .enter().append("circle")
      .attr("class", function(d) { return "dot " + d['group'] })
      .attr("opacity", "0.8")
      .attr("r", function(d) { 

        if (getW < 600) {
          return 2
        }

        else {
          return 3.5
        }
        

      })
      .attr("title", function(d) {return d['title']})
      .attr("cx", function(d) { return x(d.year); })
      .attr("cy", function(d) { return y(d.duration); })
      .style("fill", function(d) { 
        if (d['group'] == 'band') {
          return '#31a354'
        } 
        else if (d['group'] == 'urban') {
          return '#3182bd'
        } 

        else if (d['group'] == 'electronic') {
          return '#756bb1'
        } 

        else if (d['group'] == 'pop') {
          return '#de2d26'
        } 

        else if (d['group'] == 'other') {
          return '#636363'
        } 

      });

  svg.append("line")
      .attr("class", "trendline")
      .attr("x1", function(d) { return x(1988); })
      .attr("y1", function(d) { return y(255); })
      .attr("x2", function(d) { return x(2014); })
      .attr("y2", function(d) { return y(225); })
      .attr("stroke", "black")
      .attr("stroke-width", 1);    


 $("#durationGraphWrapper .dot").tooltip({
                track: true,  
                  content: function() {
                  var elementData = d3.select(this)[0][0]['__data__'];
                    return "<div class='infobox' onClick='tooltipClose();'><span class='infoboxHeader'>" + elementData['title'] + " - " + elementData['artist'] + "</span><br>Duration: " + elementData['duration'] + " seconds</div>";
                  }
                });     


function tooltipClose() {
$("#durationGraphWrapper .dot").tooltip('close');
}

 d3.selectAll("#durationGraphWrapper .btn").on("click", filterCat);

function filterCat() {

                $("#durationGraphWrapper .reset").fadeIn().css("display","inline-block");

                var currElement = d3.select(this)

                var catID = currElement.attr("data-category");

                var currCircles = d3.selectAll("#durationGraphWrapper .dot."+catID);

                if (currCircles.style("opacity") > 0) {
                    
                    $(this).addClass("greyedOut");

                    currCircles.transition()
                          .duration(300)
                          .style("opacity", 0);
                    }

                    else if (currCircles.style("opacity") == 0) {

                    $(this).removeClass("greyedOut");

                     currCircles.transition()
                          .duration(300)
                          .style("opacity", 1)
                    }

              };  





});

}

function drawlabelColumn() {

 var margin = {top: 10, right: 10, bottom: 30, left: 10},
    width = getW - margin.left - margin.right,
    height = getH - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format(".2s"));

var svg = d3.select("#labelColumn").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("data/label-percents2.csv", function(error, data) {

var headers = ["Major","Independent","Unknown","Public broadcaster"];

var layers = d3.layout.stack()(headers.map(function(categories) {
    return data.map(function(d) {
      return {
        category:categories,
        x: d.year, 
        y: +d[categories]};
    });
}));

var yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); });
var yStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });

var xScale = d3.scale.ordinal()
    .domain(layers[0].map(function(d) { return d.x; }))
    .rangeRoundBands([25, width], .08);

var y = d3.scale.linear()
    .domain([0, yStackMax])
    .range([height, 0]);

var color = d3.scale.ordinal()
    .domain(headers)
    .range(['rgb(8,81,156)','rgb(49,130,189)','rgb(107,174,214)','rgb(189,215,231)']);
      
    var xAxis = d3.svg.axis()
        .scale(xScale)
        .tickSize(0)
        .tickPadding(6)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));


    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .selectAll("text").style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                  return "rotate(-45)" 
                });
    
    svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(20,0)")
        .call(yAxis)
      .append("text")
      .attr("class", "label")
      .attr("dy", "2em")
      .attr("dx", "-0.5em")
      .style("text-anchor", "end")
      .text("%");

    var layer = svg.selectAll(".layer")
        .data(layers)
        .enter().append("g")
        .attr("class", "layer");

    var rect = layer.selectAll("rect")
        .data(function(d) {
          console.log(d);
          return d; })
        .enter().append("rect")
        .attr("x", function(d) { return xScale(d.x); })
        .attr("width", xScale.rangeBand())
        .attr("y", function(d) { return y(d.y0 + d.y); })
        .attr("class", function(d) { return d['category'] + " columnSection" })
        .attr("title", function(d) { return d['category'] })
        .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
        .style("fill", function(d) { return color(d.category) });


 $("#labelGraphWrapper .columnSection").tooltip({
        track: true,  
          content: function() {
        var elementData = d3.select(this)[0][0]['__data__'];
            return "<div class='infobox' onClick='tooltipClose();'><span class='infoboxHeader'>" + elementData['category'] + "</span><br>Proportion: " + elementData['y'].toFixed(2) + "%</div>";
          }
        });     

  function tooltipClose() {
$(".infobox").tooltip('close');
}

});



}

function drawCountryColumn() {


  var margin = {top: 10, right: 10, bottom: 30, left: 10},
    width = getW - margin.left - margin.right,
    height = getH - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format(".2s"));

var svg = d3.select("#countryColumn").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("data/country-cat-percents.csv", function(error, data) {

var headers = ["US","Australia","UK","Other"];

var layers = d3.layout.stack()(headers.map(function(categories) {
    return data.map(function(d) {
      return {
        category:categories,
        x: d.year, 
        y: +d[categories]};
    });
}));

var yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); });
var yStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });

var xScale = d3.scale.ordinal()
    .domain(layers[0].map(function(d) { return d.x; }))
    .rangeRoundBands([25, width], .08);

var y = d3.scale.linear()
    .domain([0, yStackMax])
    .range([height, 0]);

var color = d3.scale.ordinal()
    .domain(headers)
    .range(['rgb(8,81,156)','rgb(49,130,189)','rgb(107,174,214)','rgb(189,215,231)']);
      
    var xAxis = d3.svg.axis()
        .scale(xScale)
        .tickSize(0)
        .tickPadding(6)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));


    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .selectAll("text").style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                  return "rotate(-45)" 
                });
    
    svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(20,0)")
        .call(yAxis)
        .append("text")
      .attr("class", "label")
      .attr("dy", "2em")
      .attr("dx", "-0.5em")
      .style("text-anchor", "end")
      .text("%");

    var layer = svg.selectAll(".layer")
        .data(layers)
        .enter().append("g")
        .attr("class", "layer");

    var rect = layer.selectAll("rect")
        .data(function(d) {
          return d; })
        .enter().append("rect")
        .attr("x", function(d) { return xScale(d.x); })
        .attr("class", function(d) { return d['category'] + " columnSection" })
        .attr("title", function(d) { return d['category'] })
        .attr("width", xScale.rangeBand())
        .attr("y", function(d) { return y(d.y0 + d.y); })
        .attr("height", function(d) { return y(d.y0) - y(d.y0 + d.y); })
        .style("fill", function(d) { return color(d.category) });


     $("#countryGraphWrapper .columnSection").tooltip({
        track: true,  
          content: function() {
        var elementData = d3.select(this)[0][0]['__data__'];
            return "<div class='infobox' onClick='tooltipClose();'><span class='infoboxHeader'>" + elementData['category'] + "</span><br>Proportion: " + elementData['y'].toFixed(2) + "%</div>";
          }
        });     

      function tooltipClose() {
$(".infobox").tooltip('close');
}


});




}


drawStreamGraph();
drawDurationScatter();
drawlabelColumn();
drawCountryColumn();



});


</script>
</body>